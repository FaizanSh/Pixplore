<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* General body styles */
      body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #fff;
        color: #000;
      }
  
      /* Full-width header for tabs */
      .header {
        width: 100%;
        background-color: #000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0;
        border-bottom: 2px solid #444;
      }
  
      .header .tablinks {
        flex: 1;
        text-align: center;
        padding: 14px 0;
        font-size: 16px;
        color: #fff;
        background: none;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s, color 0.3s;
      }
  
      .header .tablinks:hover {
        background-color: #333;
      }
  
      .header .tablinks.active {
        background-color: #444;
      }
  
      /* Container for the main content */
      .container {
        width: 90%;
        max-width: 800px;
        margin: 20px auto;
        background: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: 1px solid #ccc;
      }
  
      /* Tab content */
      .tabcontent {
        display: none;
        padding: 20px;
      }
  
      .tabcontent h3 {
        margin-top: 0;
        color: #333;
      }
  
      /* Form and input styling */
      form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
  
      label {
        font-weight: bold;
        color: #444;
      }
  
      input[type="text"], input[type="file"], .submit {
        padding: 12px;
        border: 1px solid #bbb;
        border-radius: 5px;
        font-size: 16px;
        color: #000;
        background-color: #fff;
        transition: border-color 0.3s;
      }
  
      input[type="text"]:focus, input[type="file"]:focus, .submit:focus {
        border-color: #000;
        outline: none;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }
  
      .submit {
        background-color: #000;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
      }
  
      .submit:hover {
        background-color: #333;
      }
  
      /* Search results grid */
      #search_image_result {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Exactly 2 columns */
        gap: 15px;
        margin-top: 20px;
      }

    #search_image_result img {
      width: 100%;
      height: 400px; /* Adjusted height for better proportions */
      object-fit: cover; /* Ensures the image fills the area without distortion */
      border-radius: 5px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
      /* Responsive design for smaller screens */
      @media (max-width: 600px) {
        .header .tablinks {
          font-size: 14px;
          padding: 10px 0;
        }
  
        input[type="text"], input[type="file"], .submit {
          font-size: 14px;
          padding: 10px;
        }
  
        #search_image_result img {
          height: 150px;
        }
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
      var accessToken = "###accessToken###";
      var idToken = "###idToken###";

      localStorage.setItem("accessToken", accessToken);
      localStorage.setItem("idToken", idToken);

      console.log(window.location.href);

      var getSignedUrlEndpoint =
        window.location.href.split("/prod")[0] + "/prod/upload-photo";
      var searchImageEndpoint = "https://s6xl5rp7mf.execute-api.us-east-1.amazonaws.com/prod/search";
        
      var loginPage = "###loginPage###";
      var logoutPage = loginPage.replace("login", "logout");

      function logout() {
        window.location.replace(logoutPage);
      }



      function getSignedUrl() {
        // Log the beginning of the AJAX request
        console.log("Starting request to get signed URL...");
      
        $.ajax({
          url: getSignedUrlEndpoint,
          headers: {
            Authorization: idToken,
          },
          type: "POST",
          contentType: "application/json; charset=utf-8",
          success: function (result) {
            // Log the response from the server
            console.log("Received response from getSignedUrlEndpoint:", result);
            
            // Log the URL and the fields being set on the form
            console.log("Setting form action to:", result.url);
            console.log("Setting form fields:");
            console.log("key:", result.fields.key);
            console.log("AWSAccessKeyId", result.fields["AWSAccessKeyId"]);
            console.log("X-Amz-Security-Token:", result.fields["x-amz-security-token"]);
            console.log("Policy:", result.fields.policy);
            console.log("X-Amz-Signature:", result.fields["signature"]);
      
            // Updating form elements with received values
            $("#upload_image_form").attr("action", result.url);
            $('input[name="key"]').val(result.fields.key);
            $('input[name="AWSAccessKeyId"]').val(result.fields["AWSAccessKeyId"]);
            $('input[name="x-amz-security-token"]').val(result.fields["x-amz-security-token"]);
            $('input[name="policy"]').val(result.fields.policy);
            $('input[name="signature"]').val(result.fields["signature"]);
          },
          error: function (error) {
            // Log the error if thereâ€™s an issue with the request
            console.log("Error occurred during AJAX request:", error);
      
            if (error.status == 401) {
              console.log("Unauthorized request. Logging out...");
              logout();
            }
          },
        });
      }
      

      function listImagesByLabel(outputTab, label, language, country) {
        console.log("Finding images with label: " + label);

        var formData = language ? { label, language, country } : { label };

        $.ajax({
          url: searchImageEndpoint,
          headers: { Authorization: idToken },
          type: "POST",
          data: JSON.stringify({ ...formData, source: "API" }),
          contentType: "application/json; charset=utf-8",
          success: function (results) {
            console.log(results);
            console.log({ ...formData, source: "API" },)
            $(outputTab).empty();
            // $(outputTab + " tr").remove();
            // $(outputTab + " th").remove();
            if (results) {
              var results_body = JSON.parse(results.body);
              results_body.forEach((item) => {
                var imgElement = document.createElement("img");
                imgElement.src = item.id;
                imgElement.alt = "Image";
                $(outputTab).append(imgElement);
              });
            }

          },
          error: function (error) {
            console.log("here")
            console.log({ ...formData, source: "API" },)
            console.log(error.responseText, error.status);
            if (error.status == 401) {
              logout();
            }
          },
        });
      }

      $(document).ready(function () {
        if (window.location.hash) {
          //getSignedUrl();
        } else {
          console.log("Authorization information from cognito is not found!");
        }
      });

      function submitSearchQuery() {
        event.preventDefault();
        var language = $("#language").val();
        var country = $("#country").val();
        var label = $("input[name=label]").val();

        listImagesByLabel("#search_image_result", label, language, country);
      }

      function openTab(evt, tabName) {
        $("#upload_result").text("");
        $("#upload_result").css("color", "black");
        $("#file_select").val("");

        if (tabName == "upload") {
          getSignedUrl();
        }

        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }

      function submitFileUpload() {
        event.preventDefault();

        var formData = new FormData();
        var selectedFile = $('input[name="file"]')[0];

        $("#upload_image_form *")
          .filter(":input")
          .filter(":hidden")
          .each(function (k, v) {
            formData.append(v.name, v.defaultValue);
          });

        formData.append("file", selectedFile.files[0]);
        // Log the content of formData for debugging
        console.log("FormData content:");
        for (var pair of formData.entries()) {
          console.log(pair[0] + ": ", pair[1]);
        }
        $.ajax({
          url: $("#upload_image_form").attr("action"),
          type: "POST",
          data: formData,
          success: function (data) {
            $("#upload_result").text(
              "The file has been successfully uploaded!"
            );
            $("#upload_result").css("color", "green");
            getSignedUrl();
          },
          error: function (xhr, textStatus, errorThrown) {
            $("#upload_result").text("The file upload failed!");
            $("#upload_result").css("color", "red");
            console.log(textStatus);
            console.log(errorThrown);
          },
          cache: false,
          contentType: false,
          processData: false,
        });
      }
    </script>
  </head>

  <body>
    <div class="header">
      <button class="tablinks" onclick="openTab(event, 'upload')" id="default_tab">Upload</button>
      <button class="tablinks" onclick="openTab(event, 'search')">Search</button>
      <button class="tablinks" onclick="logout()">Logout</button>
    </div>
  
    <!-- Main container -->
    <div class="container">
      <div id="upload" class="tabcontent">
        <h3>Upload Image</h3>
        <p>Select image to upload:</p>
        <form id="upload_image_form" method="post" enctype="multipart/form-data">
          <input type="hidden" name="key" />
          <input type="hidden" name="AWSAccessKeyId" />
          <input type="hidden" name="x-amz-security-token" />
          <input type="hidden" name="policy" />
          <input type="hidden" name="signature" />
          <input type="file" id="file_select" name="file" />
          <input type="submit" class="submit" value="Upload" onclick="submitFileUpload()" />
        </form>
        <p id="upload_result"></p>
      </div>
  
      <div id="search" class="tabcontent">
        <h3>Search Labels</h3>
        <form id="search_image_form" method="post">
          <label for="label">Label to search:</label>
          <input type="text" id="label" name="label" placeholder="Enter label" />
          <input class="submit" type="submit" value="Search" onclick="submitSearchQuery()" />
        </form>
        <div id="search_image_result"></div>
      </div>
    </div>

    <script>
      document.getElementById("default_tab").click();
    </script>
  </body>
</html>